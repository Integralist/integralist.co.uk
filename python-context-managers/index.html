<!DOCTYPE HTML>
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
  <head>
    <title>Integralist</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="../assets/css/main.css" />
  </head>
  <body class="is-preload">
    <!-- Wrapper -->
    <div id="wrapper">
      <!-- Main -->
      <div id="main">
        <div class="inner">
          <!-- Header -->
					<header id="header">
						<a href="../index.html" class="logo"><strong>Home</strong></a>
							<ul class="icons">
							<!--<li><a href="https://x.com/integralist" class="icon brands fa-twitter" target="blank"><span class="label">Twitter</span></a></li>-->
							<!--<li><a href="https://instagram.com/wwfsuperstarsofwrestling" class="icon brands fa-instagram" target="blank"><span class="label">Instagram</span></a></li>-->
						</ul>
					</header>

          <!-- Content -->
          <section>
						<!--
            <header class="main">
              <h1>Royal Rumble 1989</h1>
              <p>A Bizarre Spectacle Where the Madness Multiplies</p>
            </header>
            <span class="image main"><img src="../images/rumble-89.jpg" alt="" /></span>
						-->
						<nav>

<ul>
<li><a href="#python-101-context-managers">Python 101: Context Managers</a>
<ul>
<li><a href="#introduction">Introduction</a></li>

<li><a href="#summary">Summary</a></li>

<li><a href="#what-is-a-context-manager">What is a Context Manager?</a></li>

<li><a href="#why-use-a-context-manager">Why use a Context Manager?</a></li>

<li><a href="#how-to-use-a-context-manager">How to use a Context Manager?</a>
<ul>
<li><a href="#with"><code>with</code></a></li>

<li><a href="#contextlib-contextmanager"><code>@contextlib.contextmanager</code></a></li>
</ul></li>

<li><a href="#how-to-implement-a-context-manager">How to implement a Context Manager?</a></li>

<li><a href="#when-to-use-one-or-the-other">When to use one or the other?</a></li>

<li><a href="#multiple-context-managers-in-a-single-with-statement">Multiple Context Managers in a single With statement</a></li>
</ul></li>
</ul>

</nav>

<h1 id="python-101-context-managers">Python 101: Context Managers</h1>

<h2 id="introduction">Introduction</h2>

<p>In this post I wanted to discuss a relatively simple, but important topic: Context Managers. I want to cover the what, the why and the how.</p>

<p>{{&lt; adverts/pythonforprogrammers &gt;}}</p>

<h2 id="summary">Summary</h2>

<ul>
<li>Content Managers abstract away &lsquo;clean-up&rsquo; logic.</li>
<li>Define a class with <code>__enter__</code>/<code>__exit__</code> methods.</li>
<li>The <code>__enter__</code> method is similar to a <code>try</code> block.</li>
<li>The <code>__exit__</code> method is similar to a <code>finally</code> block.</li>
<li>Reduce boilerplate with <a href="https://docs.python.org/3/library/contextlib.html#contextlib.contextmanager" target="_blank"><code>@contextlib.contextmanager</code></a>.</li>
</ul>

<h2 id="what-is-a-context-manager">What is a Context Manager?</h2>

<p>Officially&hellip;</p>

<blockquote>
<p>A context manager is an object that defines the runtime context to be established when executing a with statement. The context manager handles the entry into, and the exit from, the desired runtime context for the execution of the block of code. Context managers are normally invoked using the <code>with</code> statement, but can also be used by directly invoking their methods. &ndash; <a href="https://docs.python.org/3/reference/datamodel.html#context-managers" target="_blank">Python Docs</a></p>
</blockquote>

<p>In simpler terms it means: a Context Manager can ensure code that requires &lsquo;clean-up&rsquo; logic to be executed, is done so in a more idiomatic/Pythonic way.</p>

<h2 id="why-use-a-context-manager">Why use a Context Manager?</h2>

<p>The classic example given is when opening lots of file in Python:</p>

<pre><code>files = []

for _ in range(100000):
    f = open('foo.txt', 'w')
    files.append(f)
    f.close()
</code></pre>

<p>Notice each file object&rsquo;s <code>.close()</code> method is called to ensure the file descriptor is released. If we <em>didn&rsquo;t</em> do that, then your Operating System would exhaust its allowed limit of open file descriptors.</p>

<p>To make this code more Pythonic and cleaner, we can utilize Context Managers.</p>

<h2 id="how-to-use-a-context-manager">How to use a Context Manager?</h2>

<p>There are two ways to utilize a Context Manager&hellip;</p>

<ol>
<li><code>with</code></li>
<li><code>@contextlib.contextmanager</code></li>
</ol>

<h3 id="with"><code>with</code></h3>

<p>We can use the <code>with</code> statement to define a similar block of code to our earlier &lsquo;open multiple files&rsquo; example.</p>

<p>The <code>with</code> statement expects a &lsquo;Context Manager&rsquo; to be provided, and there are already a few built-in Python objects designed as Context Managers; such as the <code>open</code> function we saw used in our above example code.</p>

<blockquote>
<p>Note: another example is <a href="https://docs.python.org/3/library/threading.html#threading.Lock" target="_blank">threading.Lock</a>.</p>
</blockquote>

<p>Here is what the code might look like when using <code>with</code>:</p>

<pre><code>files = []

for _ in range(100000):
    with open('foo.txt', 'w') as f:
        files.append(f)
</code></pre>

<p>Notice how we didn&rsquo;t have to explicitly call <code>.close()</code> on each file object generated by <code>open</code>. That&rsquo;s because <code>open</code> works as a Context Manager and knows how to clean-up after itself when called via the <code>with</code> statement.</p>

<p>We&rsquo;ll show you how to implement your own Context Manager in the following section: <a href="#how-to-implement-a-context-manager">How to implement a Context Manager?</a>.</p>

<h3 id="contextlib-contextmanager"><code>@contextlib.contextmanager</code></h3>

<p>Python provides a decorator function <code>@contextlib.contextmanager</code> which is actually a callable class (i.e. it defines <code>__call__</code> magic method) that enables custom context managers (e.g. your own code you want to act as a context manager) to use simpler code than the traditional &lsquo;class-based&rsquo; implementation we previously mentioned.</p>

<p>This means if you have custom objects that need to implement clean-up logic (similar to how <code>open</code> does), then you can decorate your own function so it <em>behaves</em> like a Context Manager, while your function itself simply uses a <code>yield</code> statement, like so:</p>

<pre><code>from contextlib import contextmanager

files = []

@contextmanager
def open_file(path, mode): 
    file = open(path, mode)
    yield file
    file.close()

for _ in range(100000):
    with open_file('foo.txt', 'w') as f:
        files.append(f)
</code></pre>

<p>In the above example code we&rsquo;ve effectively recreated the <code>open</code> Context Manager just to demonstrate the principle.</p>

<h2 id="how-to-implement-a-context-manager">How to implement a Context Manager?</h2>

<p>Now we&rsquo;ve already seen how to implement a Context Manager using the <code>@contextlib.contextmanager</code> decorator (see previous sub-section), but how do we implement a class-based version of a Context Manager?</p>

<p>That requires us to define a class which implements <code>__enter__</code> and <code>__exit__</code> methods. Below is an example, again replicating the <code>open</code> function to keep things simple:</p>

<pre><code>files = []

class Open():
    def __init__(self, filename, mode):
        self.filename = filename
        self.mode = mode

    def __enter__(self):
        self.open_file = open(self.filename, self.mode)
        return self.open_file

    def __exit__(self, *args):
        self.open_file.close()

for _ in range(100000):
    with Open('foo.txt', 'w') as f:
        files.append(f)
</code></pre>

<blockquote>
<p>Note: for more information, see <a href="https://docs.python.org/3/library/stdtypes.html#typecontextmanager" target="_blank">Context Manager Types</a>.</p>
</blockquote>

<h2 id="when-to-use-one-or-the-other">When to use one or the other?</h2>

<p>One thing I noticed recently was that the <code>contextmanager</code> variation wouldn&rsquo;t execute an &lsquo;exit&rsquo; if an exception was raised during execution of the code, while the more verbose &lsquo;class-based&rsquo; implementation <em>would</em>. See the following code for an example&hellip;</p>

<pre><code>from contextlib import contextmanager

@contextmanager
def foo():
    print(&quot;enter!&quot;)
    yield &quot;foobar&quot;
    print(&quot;exit!&quot;)

try:
    with foo() as f:
        raise Exception(&quot;unexpected&quot;)
        print(f&quot;f was: {f}&quot;)
except Exception as e:
    print(f&quot;whoops: {e}&quot;)
</code></pre>

<p>The output is not what I expected:</p>

<pre><code>enter!
whoops: unexpected
</code></pre>

<p>Notice how there is no <code>exit!</code> printed.</p>

<p>Now compare this to a &lsquo;class-based&rsquo; example&hellip;</p>

<pre><code>class Foo():
    def __enter__(self):
        print(&quot;enter!&quot;)

    def __exit__(self, *args):
        print(&quot;exit!&quot;, args)

try:
    with Foo() as f:
        raise Exception(&quot;unexpected&quot;)
        print(f&quot;f was: {f}&quot;)
except Exception as e:
    print(f&quot;whoops: {e}&quot;)
</code></pre>

<p>The output is as expected:</p>

<pre><code>enter!
exit! (&lt;class 'Exception'&gt;, Exception('unexpected'), &lt;traceback object at 0x108882d00&gt;)
whoops: unexpected
</code></pre>

<p>i.e. we see <em>both</em> an enter and exit message.</p>

<p>We can get the <code>contextmanager</code> to behave as we might have expected it to (e.g. the same as the &lsquo;class-based&rsquo; implementation) by ensuring the function that calls <code>yield</code> is wrapped in a <code>try/finally</code> block, like so:</p>

<pre><code>from contextlib import contextmanager

@contextmanager
def foo():
    print(&quot;enter!&quot;)
    try:
        yield &quot;foobar&quot;
    finally:
        print(&quot;exit!&quot;)

try:
    with foo() as f:
        raise Exception(&quot;unexpected&quot;)
        print(f&quot;f was: {f}&quot;)
except Exception as e:
    print(f&quot;whoops: {e}&quot;)
</code></pre>

<p>The output of this is now what we might expect&hellip;</p>

<pre><code>enter!
exit!
whoops: unexpected
</code></pre>

<p>When choosing between the two options <code>contextmanager</code> and &lsquo;class-based&rsquo; implementation, it might be worth keeping this caveat in mind.</p>

<h2 id="multiple-context-managers-in-a-single-with-statement">Multiple Context Managers in a single With statement</h2>

<p>One interesting aspect of the <code>with</code> statement is that you can execute multiple context managers as part of its block control. Meaning when the <code>with</code> block completes, then all context managers will be cleaned up.</p>

<pre><code>from contextlib import contextmanager

@contextmanager
def foo():
    print(&quot;enter!&quot;)
    try:
        yield &quot;foobar&quot;
    finally:
        print(&quot;exit!&quot;)


with foo() as f1, foo() as f2, foo() as f3:
    print(f&quot;f1 was: {f1}&quot;)
    print(f&quot;f2 was: {f2}&quot;)
    print(f&quot;f3 was: {f3}&quot;)
</code></pre>

<p>Alternatively you can utilize <code>contextlib.ExitStack</code>:</p>

<pre><code>from contextlib import contextmanager, ExitStack

@contextmanager
def foo():
    print(&quot;enter!&quot;)
    try:
        yield &quot;foobar&quot;
    finally:
        print(&quot;exit!&quot;)

with ExitStack() as stack:
    managers = [stack.enter_context(foo()) for cm in range(3)]
    print(managers)  # ['foobar', 'foobar', 'foobar']
</code></pre>

          </section>
        </div>
      </div>
      <!-- Sidebar -->
<div id="sidebar">
  <div class="inner">
    <!-- Search -->
    <!--<section id="search" class="alt">-->
    <!--  <form method="post" action="#">-->
    <!--    <input type="text" name="query" id="query" placeholder="Search" />-->
    <!--  </form>-->
    <!--</section>-->
    <!-- Menu -->
    <nav id="menu">
      <header class="major">
        <h2>Menu</h2>
      </header>
      <ul>
        <li><a href="../index.html">About</a></li>
        <!--<li><a href="../resume/index.html">Resume</a></li>-->
				
      </ul>
    </nav>
    <!-- Section -->
		<!--
    <section>
      <header class="major">
        <h2>Highlights</h2>
      </header>
      <div class="mini-posts">
        <article>
          <a href="ppv-survivorseries-88.html" class="image"><img src="../images/survivor-88-index.jpg" alt="" /></a>
          <p>Get ready for the ultimate showdown as Survivor Series 1988 brings non-stop tag team action, fierce rivalries, and unforgettable battles between the biggest WWF superstars!</p>
        </article>
        <article>
          <a href="ppv-royalrumble-89.html" class="image"><img src="../images/rumble-89-index.jpg" alt="" /></a>
          <p>Royal Rumble 1989 unleashes chaos with 30 superstars battling for glory in an unforgettable over-the-top-rope showdown!</p>
        </article>
        <article>
          <a href="ppv-summerslam-88.html" class="image"><img src="../images/slam-88-index.jpg" alt="" /></a>
          <p>SummerSlam 1988 delivers explosive action with iconic matchups, as the WWF's biggest stars collide in the hottest event of the summer!</p>
        </article>
      </div>
    </section>
		-->
    <!-- Section -->
    <!--<section>-->
    <!--  <header class="major">-->
    <!--    <h2>Get in touch</h2>-->
    <!--  </header>-->
    <!--  <p>Sed varius enim lorem ullamcorper dolore aliquam aenean ornare velit lacus, ac varius enim lorem ullamcorper dolore. Proin sed aliquam facilisis ante interdum. Sed nulla amet lorem feugiat tempus aliquam.</p>-->
    <!--  <ul class="contact">-->
    <!--    <li class="icon solid fa-envelope"><a href="#">information@untitled.tld</a></li>-->
    <!--    <li class="icon solid fa-phone">(000) 000-0000</li>-->
    <!--    <li class="icon solid fa-home">1234 Somewhere Road #8254<br />-->
    <!--      Nashville, TN 00000-0000</li>-->
    <!--  </ul>-->
    <!--</section>-->
    <!-- Footer -->
    <footer id="footer">
      <p class="copyright">&copy; Integralist. All rights reserved.</p>
      <p class="copyright small">Demo Images: <a href="https://unsplash.com">Unsplash</a>. Design: <a href="https://html5up.net">HTML5 UP</a>.</p>
    </footer>
  </div>
</div>

    </div>
    <!-- Scripts -->
    <script src="../assets/js/jquery.min.js"></script>
    <script src="../assets/js/browser.min.js"></script>
    <script src="../assets/js/breakpoints.min.js"></script>
    <script src="../assets/js/util.js"></script>
    <script src="../assets/js/main.js"></script>
  </body>
</html>
